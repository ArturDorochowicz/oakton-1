<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Environment Checks | Oakton</title>
    <meta name="description" content="Add Robust Command Line Options to .Net Applications">
    <link rel="stylesheet" href="/assets/style.13643d27.css">
    <link rel="modulepreload" href="/assets/Home.22248d41.js">
    <link rel="modulepreload" href="/assets/AlgoliaSearchBox.23657f47.js">
    <link rel="modulepreload" href="/assets/app.148d2893.js">
    <link rel="modulepreload" href="/assets/guide_host_environment.md.085a2083.lean.js">
    
    <meta name="twitter:title" content="Environment Checks | Oakton">
    <meta property="og:title" content="Environment Checks | Oakton">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme"><header class="nav-bar" data-v-675d8756><div class="sidebar-button" data-v-675d8756><svg class="icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z" class></path></svg></div><a class="nav-bar-title" href="/" aria-label="Oakton, back to home" data-v-675d8756 data-v-4a583abe><!----> Oakton</a><div class="flex-grow" data-v-675d8756></div><div class="nav" data-v-675d8756><nav class="nav-links" data-v-675d8756 data-v-eab3edfe><!--[--><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item active" href="/guide/" data-v-b8818f8c>Guide <!----></a></div></div><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item isExternal" href="https://gitter.im/JasperFx/oakton?utm_source=badge&amp;utm_medium=badge&amp;utm_campaign=pr-badge&amp;utm_content=badge" target="_blank" rel="noopener noreferrer" data-v-b8818f8c>Gitter | Join Chat <svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" data-v-b8818f8c><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div></div><!--]--><!----><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item isExternal" href="https://github.com/JasperFx/oakton" target="_blank" rel="noopener noreferrer" data-v-b8818f8c>GitHub <svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" data-v-b8818f8c><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div></div></nav></div><!--[--><!--[--><div class="algolia-search-box" id="docsearch"></div><!--]--><!--]--></header><aside class="sidebar" data-v-83e92a68><nav class="nav-links nav" data-v-83e92a68 data-v-eab3edfe><!--[--><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item active" href="/guide/" data-v-b8818f8c>Guide <!----></a></div></div><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item isExternal" href="https://gitter.im/JasperFx/oakton?utm_source=badge&amp;utm_medium=badge&amp;utm_campaign=pr-badge&amp;utm_content=badge" target="_blank" rel="noopener noreferrer" data-v-b8818f8c>Gitter | Join Chat <svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" data-v-b8818f8c><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div></div><!--]--><!----><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item isExternal" href="https://github.com/JasperFx/oakton" target="_blank" rel="noopener noreferrer" data-v-b8818f8c>GitHub <svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" data-v-b8818f8c><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div></div></nav><!--[--><!--]--><ul class="sidebar-links" data-v-83e92a68><!--[--><li class="sidebar-link"><a class="sidebar-link-item" href="/guide/">Getting Started</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="/guide/commands">Commands</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/guide/host/">Integration with IHost</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="/guide/host/run">Improved &quot;Run&quot; Command</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item active" href="/guide/host/environment">Environment Checks</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="#how-it-works">How it works</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#running-environment-checks">Running Environment Checks</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#adding-environment-checks">Adding Environment Checks</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#custom-environment-checks">Custom Environment Checks</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#required-files">Required Files</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#required-service-registration">Required Service Registration</a><!----></li></ul></li><li class="sidebar-link"><a class="sidebar-link-item" href="/guide/host/extensions">Writing Extension Commands</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/guide/host/describe">The &quot;describe&quot; command</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/guide/host/resources">Stateful Resources</a><!----></li></ul></li><li class="sidebar-link"><a class="sidebar-link-item" href="/guide/bootstrapping">Bootstrapping with CommandExecutor</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/guide/parsing">Parsing Arguments and Optional Flags</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/guide/help">Help Text</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/guide/opts">&quot;Opts&quot; Files</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/guide/discovery">Command Assembly Discovery</a><!----></li></ul></li><!--]--></ul><!--[--><!--]--></aside><div class="sidebar-mask"></div><main class="page" data-v-7eddb2c4><div class="container" data-v-7eddb2c4><!--[--><!--]--><div style="position:relative;" class="content" data-v-7eddb2c4><div><h1 id="environment-checks" tabindex="-1">Environment Checks <a class="header-anchor" href="#environment-checks" aria-hidden="true">#</a></h1><p>The big out of the box feature with Oakton.AspNetCore is the ability to expose environment checks or environment tests directly in your application. Most applications don&#39;t live in isolation. Your code probably has to interact with databases, the file system, configuration mechanisms, and other services. And since it&#39;s an imperfect world, it&#39;s quite possible that you&#39;ve made a deployment in your career and later found out that configuration items were wrong, your dependencies were down, the database credentials you were using were wrong, or all kinds of sundry run of the mill problems.</p><p>Years ago I worked on a system that had worlds of environmental issues during deployments, and after learning about the technique of &quot;environment tests&quot; where you build in automatic checks in your deployment to exercise your system&#39;s integrations, we adapted the approach described here: <a href="http://codebetter.com/jeremymiller/2006/04/06/environment-tests-and-self-diagnosing-configuration-with-structuremap/" target="_blank" rel="noopener noreferrer">Environment Tests and Self-Diagnosing Configuration</a>.</p><p>Flash forward to 2019 (at the time of this release), and Oakton.AspNetCore allows you to build environment checks right into your ASP.Net Core application such that you can verify successful deployments to verify the system configuration quickly rather than waiting for user error reports or testers being blocked because the system is down (which happened to me today as a matter of fact).</p><p>Here&#39;s a quick start. Let&#39;s say that your ASP.Net Core application talks to a single Sql Server application database, and that you expect there to be a connection string in your <em>appsettings.json</em> like so:</p><div class="language-"><pre><code>{
    &quot;connectionString&quot;: &quot;some connection string using integrated security&quot;
}
</code></pre></div><p>In a perfect world that just works and every thing is hunky dory. In the real world maybe the configuration is missing, the appsettings.json file didn&#39;t get copied over somehow, the service account your application is running under doesn&#39;t have access to the configured Sql Server database (this wasn&#39;t a random example), or the database just flat out doesn&#39;t exist (also not a random example).</p><p>To build in an environment check for database connectivity in this situation with <em>Oakton.AspNetCore</em>, get into your normal ASP.Net Core <code>Startup</code> class, and add an environment check in the <code>Startup.ConfigureServices()</code> method like this:</p><p><a id="snippet-sample_configureservice_with_environmentcheck"></a></p><div class="language-cs"><pre><code><span class="token comment">// This method gets called by the runtime. Use this method to add services to the container.</span>
<span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">ConfigureServices</span><span class="token punctuation">(</span><span class="token class-name">IServiceCollection</span> services<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// Other registrations we don&#39;t care about...</span>
    
    <span class="token comment">// This extension method is in Oakton.AspNetCore</span>
    services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">CheckEnvironment</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IConfiguration<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">&quot;Can connect to the application database&quot;</span><span class="token punctuation">,</span> config <span class="token operator">=&gt;</span>
    <span class="token punctuation">{</span>
        <span class="token class-name"><span class="token keyword">var</span></span> connectionString <span class="token operator">=</span> config<span class="token punctuation">[</span><span class="token string">&quot;connectionString&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> conn <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">SqlConnection</span><span class="token punctuation">(</span>connectionString<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token comment">// Just attempt to open the connection. If there&#39;s anything</span>
            <span class="token comment">// wrong here, it&#39;s going to throw an exception</span>
            conn<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// Ignore this please;)</span>
    services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddSingleton</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IDescribedSystemPart<span class="token punctuation">,</span> Describer1<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddSingleton</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IDescribedSystemPart<span class="token punctuation">,</span> Describer2<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddSingleton</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IDescribedSystemPart<span class="token punctuation">,</span> Describer3<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><sup><a href="https://github.com/JasperFx/alba/blob/master/src/MvcApp/Startup.cs#L30-L53" title="Snippet source file">snippet source</a> | <a href="#snippet-sample_configureservice_with_environmentcheck" title="Start of snippet">anchor</a></sup></p><p>Now, during deployments or even just pulling down the code to run locally, we can run the environment checks on our application like so:</p><div class="language-"><pre><code>dotnet run -- check-env
</code></pre></div><p>Which in the case of our application above, blows up with output like this because I didn&#39;t add configuration for the database in the first place:</p><div class="language-"><pre><code>Running Environment Checks
   1.) Failed: Can connect to the application database
System.InvalidOperationException: The ConnectionString property has not been initialized.
   at System.Data.SqlClient.SqlConnection.PermissionDemand()
   at System.Data.SqlClient.SqlConnectionFactory.Permissi
onDemand(DbConnection outerConnection)
   at System.Data.ProviderBase.DbConnectionInternal.TryOpenConnectionInternal(DbConnection outerConnection, DbConnectionFactory connectionFactory, TaskCompletionSource`1
 retry, DbConnectionOptions userOptions)
   at System.Data.ProviderBase.DbConnectionClosed.TryOpenConnection(DbConnection outerConnection, DbConnectionFactory connectionFactory, TaskCompletionSource`1 retry, 
DbConnectionOptions userOptions)
   at System.Data.SqlClient.SqlConnection.TryOpen(TaskCompletionSource`1 retry)
   at System.Data.SqlClient.SqlConnection.Open()
   at MvcApp.Startup.&lt;&gt;c.&lt;ConfigureServices&gt;b_
_4_0(IConfiguration config) in /Users/jeremydmiller/code/oakton/src/MvcApp/Startup.cs:line 41
   at Oakton.AspNetCore.Environment.EnvironmentCheckExtensions.&lt;&gt;c__DisplayClass2_0`1.&lt;CheckEnvironment&gt;b__0(IServ
iceProvider s, CancellationToken c) in /Users/jeremydmiller/code/oakton/src/Oakton.AspNetCore/Environment/EnvironmentCheckExtensions.cs:line 53
   at Oakton.AspNetCore.Environment.LambdaCheck.Assert(IServiceP
rovider services, CancellationToken cancellation) in /Users/jeremydmiller/code/oakton/src/Oakton.AspNetCore/Environment/LambdaCheck.cs:line 19
   at Oakton.AspNetCore.Environment.EnvironmentChecker.ExecuteAll
EnvironmentChecks(IServiceProvider services, CancellationToken token) in /Users/jeremydmiller/code/oakton/src/Oakton.AspNetCore/Environment/EnvironmentChecker.cs:line 31
</code></pre></div><p>If you ran this command during continuous deployment scripts, the command should cause your build to fail when it detects environment problems.</p><h2 id="how-it-works" tabindex="-1">How it works <a class="header-anchor" href="#how-it-works" aria-hidden="true">#</a></h2><p>There&#39;s not much to it. <em>Oakton.AspNetCore</em> includes this interface:</p><p><a id="snippet-sample_ienvironmentcheck"></a></p><div class="language-cs"><pre><code><span class="token comment">/// &lt;summary&gt;</span>
<span class="token comment">///     Executed during bootstrapping time to carry out environment tests</span>
<span class="token comment">///     against the application</span>
<span class="token comment">/// &lt;/summary&gt;</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IEnvironmentCheck</span>
<span class="token punctuation">{</span>
    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">///     A textual description for command line output that describes</span>
    <span class="token comment">///     what is being checked</span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token return-type class-name"><span class="token keyword">string</span></span> Description <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">///     Asserts that the current check is valid. Throw an exception</span>
    <span class="token comment">///     to denote a failure</span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token return-type class-name">Task</span> <span class="token function">Assert</span><span class="token punctuation">(</span><span class="token class-name">IServiceProvider</span> services<span class="token punctuation">,</span> <span class="token class-name">CancellationToken</span> cancellation<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><sup><a href="https://github.com/JasperFx/alba/blob/master/src/Oakton/Environment/IEnvironmentCheck.cs#L7-L26" title="Snippet source file">snippet source</a> | <a href="#snippet-sample_ienvironmentcheck" title="Start of snippet">anchor</a></sup></p><p><em>Oakton.AspNetCore</em> is looking for service registrations of this interface in your application&#39;s IoC container. The <code>CheckEnvironment()</code> extension method above just adds a service registration for the <code>IEnvironmentCheck</code> interface that runs the supplied lambda. When executing the environment checks, <em>Oakton.AspNetCore</em> runs each check one within <code>try/catch</code> blocks. If the execution throws an exception, it&#39;s considered to be a failure. Otherwise, it&#39;s a passing check and comes out in the output color coded as green. <em>Oakton.AspNetCore</em> assumes that you take care of any necessary resource cleanup yourself.</p><p>If you ever want to run the environment checks outside of the command line, you can use the <code>EnvironmentChecker.ExecuteAllEnvironmentChecks(IServiceProvider)</code> method.</p><h2 id="running-environment-checks" tabindex="-1">Running Environment Checks <a class="header-anchor" href="#running-environment-checks" aria-hidden="true">#</a></h2><p>To run the environment checks from the command line from your application, use this command:</p><div class="language-"><pre><code>dotnet run -- check-env
</code></pre></div><p>Just like the <em>run</em> command, you can also override the hosting environment or configuration items like so:</p><div class="language-"><pre><code>dotnet run -- check-env --environment UAT --config:filepath &quot;some file path&quot;
</code></pre></div><p>In addition, you can run the environment checks as part of the <em>run</em> command before starting Kestrel. If the environment checks fail, the application doesn&#39;t start and the <code>Program.Main()</code> method will throw an exception to <a href="https://en.wikipedia.org/wiki/Fail-fast" target="_blank" rel="noopener noreferrer">fail fast</a>.</p><p>In the case of successful environment checks (what you hope happens everytime), you&#39;ll see output like this listing off the successful checks. <em>All environment checks are good!</em> will be highlighted in green.</p><div class="language-"><pre><code>Running Environment Checks
   1.) Success: good
   2.) Success: also good
All environment checks are good!
</code></pre></div><p>Just to reiterate that all the normal ASP.Net Core options are available, check out the command line help for the <em>check-env</em> command like so:</p><div class="language-"><pre><code>dotnet run -- ? check-env
</code></pre></div><p>Which gives the following output:</p><div class="language-"><pre><code> Usages for &#39;check-env&#39; (Execute all environment checks against the application)
  check-env [-f, --file &lt;file&gt;] [-e, --environment &lt;environment&gt;] [-v, --verbose] [-l, --log-level &lt;logleve&gt;] [----config:&lt;prop&gt; &lt;value&gt;]

  ------------------------------------------------------------------------------------------------------------------
    Flags
  ------------------------------------------------------------------------------------------------------------------
                  [-f, --file &lt;file&gt;] -&gt; Use to optionally write the results of the environment checks to a file
    [-e, --environment &lt;environment&gt;] -&gt; Use to override the ASP.Net Environment name
                      [-v, --verbose] -&gt; Write out much more information at startup and enables console logging
          [-l, --log-level &lt;logleve&gt;] -&gt; Override the log level
          [----config:&lt;prop&gt; &lt;value&gt;] -&gt; Overwrite individual configuration items
  ------------------------------------------------------------------------------------------------------------------
</code></pre></div><h2 id="adding-environment-checks" tabindex="-1">Adding Environment Checks <a class="header-anchor" href="#adding-environment-checks" aria-hidden="true">#</a></h2><p>The easiest thing to do is to use the extension methods on <code>IServiceCollection</code> shown below:</p><p><a id="snippet-sample_configureservice_with_environmentcheck"></a></p><div class="language-cs"><pre><code><span class="token comment">// This method gets called by the runtime. Use this method to add services to the container.</span>
<span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">ConfigureServices</span><span class="token punctuation">(</span><span class="token class-name">IServiceCollection</span> services<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// Other registrations we don&#39;t care about...</span>
    
    <span class="token comment">// This extension method is in Oakton.AspNetCore</span>
    services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">CheckEnvironment</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IConfiguration<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">&quot;Can connect to the application database&quot;</span><span class="token punctuation">,</span> config <span class="token operator">=&gt;</span>
    <span class="token punctuation">{</span>
        <span class="token class-name"><span class="token keyword">var</span></span> connectionString <span class="token operator">=</span> config<span class="token punctuation">[</span><span class="token string">&quot;connectionString&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> conn <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">SqlConnection</span><span class="token punctuation">(</span>connectionString<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token comment">// Just attempt to open the connection. If there&#39;s anything</span>
            <span class="token comment">// wrong here, it&#39;s going to throw an exception</span>
            conn<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// Ignore this please;)</span>
    services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddSingleton</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IDescribedSystemPart<span class="token punctuation">,</span> Describer1<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddSingleton</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IDescribedSystemPart<span class="token punctuation">,</span> Describer2<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddSingleton</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IDescribedSystemPart<span class="token punctuation">,</span> Describer3<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><sup><a href="https://github.com/JasperFx/alba/blob/master/src/MvcApp/Startup.cs#L30-L53" title="Snippet source file">snippet source</a> | <a href="#snippet-sample_configureservice_with_environmentcheck" title="Start of snippet">anchor</a></sup></p><p>There are various overloads of <code>CheckEnvironment()</code> for both synchronous and asynchronous checks, and specialized shortcuts as shown above that let you specify a specific service registered in your IoC container for the check. Otherwise, the overloads take in either <code>Func&lt;IServiceProvider, CancellationToken, Task&gt;</code> for asynchronous checks or <code>Action&lt;IServiceProvider&gt;</code> for synchronous code checks.</p><h2 id="custom-environment-checks" tabindex="-1">Custom Environment Checks <a class="header-anchor" href="#custom-environment-checks" aria-hidden="true">#</a></h2><p>You can create custom, reusable environment checks by implementing the interface below:</p><p><a id="snippet-sample_ienvironmentcheck"></a></p><div class="language-cs"><pre><code><span class="token comment">/// &lt;summary&gt;</span>
<span class="token comment">///     Executed during bootstrapping time to carry out environment tests</span>
<span class="token comment">///     against the application</span>
<span class="token comment">/// &lt;/summary&gt;</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IEnvironmentCheck</span>
<span class="token punctuation">{</span>
    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">///     A textual description for command line output that describes</span>
    <span class="token comment">///     what is being checked</span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token return-type class-name"><span class="token keyword">string</span></span> Description <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">///     Asserts that the current check is valid. Throw an exception</span>
    <span class="token comment">///     to denote a failure</span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token return-type class-name">Task</span> <span class="token function">Assert</span><span class="token punctuation">(</span><span class="token class-name">IServiceProvider</span> services<span class="token punctuation">,</span> <span class="token class-name">CancellationToken</span> cancellation<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><sup><a href="https://github.com/JasperFx/alba/blob/master/src/Oakton/Environment/IEnvironmentCheck.cs#L7-L26" title="Snippet source file">snippet source</a> | <a href="#snippet-sample_ienvironmentcheck" title="Start of snippet">anchor</a></sup></p><p>And adding your custom type to your service registrations when you configure your IoC container (<code>Startup.ConfigureServices()</code>).</p><h2 id="required-files" tabindex="-1">Required Files <a class="header-anchor" href="#required-files" aria-hidden="true">#</a></h2><p>There&#39;s a specialized, built in check for required files like so:</p><p><a id="snippet-sample_checkthatfileexists"></a></p><div class="language-cs"><pre><code><span class="token comment">/// &lt;summary&gt;</span>
<span class="token comment">/// Issue an environment check for the existence of a named file</span>
<span class="token comment">/// &lt;/summary&gt;</span>
<span class="token comment">/// &lt;param name=&quot;services&quot;&gt;&lt;/param&gt;</span>
<span class="token comment">/// &lt;param name=&quot;path&quot;&gt;&lt;/param&gt;</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">CheckThatFileExists</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">IServiceCollection</span> services<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> path<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name"><span class="token keyword">var</span></span> check <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">FileExistsCheck</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
    services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddSingleton</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IEnvironmentCheck<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>check<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><sup><a href="https://github.com/JasperFx/alba/blob/master/src/Oakton/Environment/EnvironmentCheckExtensions.cs#L76-L87" title="Snippet source file">snippet source</a> | <a href="#snippet-sample_checkthatfileexists" title="Start of snippet">anchor</a></sup></p><h2 id="required-service-registration" tabindex="-1">Required Service Registration <a class="header-anchor" href="#required-service-registration" aria-hidden="true">#</a></h2><p>There&#39;s also a specialized check to ascertain that a required IoC service registration exists:</p><p><a id="snippet-sample_checkserviceisregistered"></a></p><div class="language-cs"><pre><code><span class="token comment">/// &lt;summary&gt;</span>
<span class="token comment">/// Issue an environment check for the registration of a service in the underlying IoC</span>
<span class="token comment">/// container</span>
<span class="token comment">/// &lt;/summary&gt;</span>
<span class="token comment">/// &lt;param name=&quot;services&quot;&gt;&lt;/param&gt;</span>
<span class="token comment">/// &lt;typeparam name=&quot;T&quot;&gt;&lt;/typeparam&gt;</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token generic-method"><span class="token function">CheckServiceIsRegistered</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">IServiceCollection</span> services<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    services<span class="token punctuation">.</span><span class="token function">CheckEnvironment</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$&quot;Service </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp"><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">T</span><span class="token punctuation">)</span><span class="token punctuation">.</span>FullName</span><span class="token punctuation">}</span></span><span class="token string"> should be registered&quot;</span></span><span class="token punctuation">,</span> s <span class="token operator">=&gt;</span> s<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetRequiredService</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/// &lt;summary&gt;</span>
<span class="token comment">/// Issue an environment check for the registration of a service in the underlying IoC</span>
<span class="token comment">/// container</span>
<span class="token comment">/// &lt;/summary&gt;</span>
<span class="token comment">/// &lt;param name=&quot;services&quot;&gt;&lt;/param&gt;</span>
<span class="token comment">/// &lt;param name=&quot;serviceType&quot;&gt;&lt;/param&gt;</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">CheckServiceIsRegistered</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">IServiceCollection</span> services<span class="token punctuation">,</span> <span class="token class-name">Type</span> serviceType<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    services<span class="token punctuation">.</span><span class="token function">CheckEnvironment</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$&quot;Service </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">serviceType<span class="token punctuation">.</span>FullName</span><span class="token punctuation">}</span></span><span class="token string"> should be registered&quot;</span></span><span class="token punctuation">,</span> s <span class="token operator">=&gt;</span> s<span class="token punctuation">.</span><span class="token function">GetRequiredService</span><span class="token punctuation">(</span>serviceType<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><sup><a href="https://github.com/JasperFx/alba/blob/master/src/Oakton/Environment/EnvironmentCheckExtensions.cs#L89-L111" title="Snippet source file">snippet source</a> | <a href="#snippet-sample_checkserviceisregistered" title="Start of snippet">anchor</a></sup></p></div></div><footer class="page-footer" data-v-7eddb2c4 data-v-fb8d84c6><div class="edit" data-v-fb8d84c6><div class="edit-link" data-v-fb8d84c6 data-v-1ed99556><a class="link" href="https://github.com/JasperFx/oakton/edit/master/docs/guide/host/environment.md" target="_blank" rel="noopener noreferrer" data-v-1ed99556>Suggest changes to this page <svg class="icon outbound icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" data-v-1ed99556><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div></div><div class="updated" data-v-fb8d84c6><!----></div></footer><div class="next-and-prev-link" data-v-7eddb2c4 data-v-38ede35f><div class="container" data-v-38ede35f><div class="prev" data-v-38ede35f><a class="link" href="/guide/host/run" data-v-38ede35f><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" class="icon icon-prev" data-v-38ede35f><path d="M19,11H7.4l5.3-5.3c0.4-0.4,0.4-1,0-1.4s-1-0.4-1.4,0l-7,7c-0.1,0.1-0.2,0.2-0.2,0.3c-0.1,0.2-0.1,0.5,0,0.8c0.1,0.1,0.1,0.2,0.2,0.3l7,7c0.2,0.2,0.5,0.3,0.7,0.3s0.5-0.1,0.7-0.3c0.4-0.4,0.4-1,0-1.4L7.4,13H19c0.6,0,1-0.4,1-1S19.6,11,19,11z"></path></svg><span class="text" data-v-38ede35f>Improved &quot;Run&quot; Command</span></a></div><div class="next" data-v-38ede35f><a class="link" href="/guide/host/extensions" data-v-38ede35f><span class="text" data-v-38ede35f>Writing Extension Commands</span><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" class="icon icon-next" data-v-38ede35f><path d="M19.9,12.4c0.1-0.2,0.1-0.5,0-0.8c-0.1-0.1-0.1-0.2-0.2-0.3l-7-7c-0.4-0.4-1-0.4-1.4,0s-0.4,1,0,1.4l5.3,5.3H5c-0.6,0-1,0.4-1,1s0.4,1,1,1h11.6l-5.3,5.3c-0.4,0.4-0.4,1,0,1.4c0.2,0.2,0.5,0.3,0.7,0.3s0.5-0.1,0.7-0.3l7-7C19.8,12.6,19.9,12.5,19.9,12.4z"></path></svg></a></div></div></div><!--[--><!--]--></div></main></div><!----><!--]--></div>
    <script>__VP_HASH_MAP__ = JSON.parse("{\"guide_bootstrapping.md\":\"b8b164b8\",\"guide_commands.md\":\"d1d55b30\",\"guide_discovery.md\":\"4b8bb157\",\"guide_getting_started.md\":\"be55ae46\",\"guide_help.md\":\"effcb29e\",\"guide_host_describe.md\":\"cf4a81b3\",\"guide_host_environment.md\":\"085a2083\",\"guide_host_extensions.md\":\"34826a9f\",\"guide_host_index.md\":\"9f9fb1df\",\"guide_host_resources.md\":\"030507ae\",\"guide_host_run.md\":\"f689bcd2\",\"guide_index.md\":\"ebaacaef\",\"guide_opts.md\":\"48842e7b\",\"guide_parsing.md\":\"b2a2f68a\",\"index.md\":\"780ab9bd\"}")</script>
    <script type="module" async src="/assets/app.148d2893.js"></script>
    
  </body>
</html>