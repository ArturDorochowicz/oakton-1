<!DOCTYPE html>
<html lang="en">
    <head>
        <meta http-equiv="content-type" content="text/html; charset=UTF-8">
        <meta charset="utf-8">
        <meta name="generator" content="Bootply" />
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
		<link rel=icon href=/content/images/favicon.ico>
		<title>Oakton - Environment Checks</title>
		<link href="/oakton/content/bootstrap.min.css" rel="stylesheet" type="text/css" />
		<link href="/oakton/content/prism.css" rel="stylesheet" type="text/css" />
		<link href="/oakton/content/theme.css" rel="stylesheet" type="text/css" />




        <link rel="apple-touch-icon" href="/bootstrap/img/apple-touch-icon.png">
        <link rel="apple-touch-icon" sizes="72x72" href="/bootstrap/img/apple-touch-icon-72x72.png">
        <link rel="apple-touch-icon" sizes="114x114" href="/bootstrap/img/apple-touch-icon-114x114.png">

        <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" />

        <!-- CSS code from Bootply.com editor -->
        <link href="/oakton/content/affix.css" rel="stylesheet" type="text/css" />
    </head>

    <!-- HTML code from Bootply.com editor -->

    <body  >


        <nav class="navbar navbar-default navbar-fixed-top" role="banner">
		  <div class="container">
		    <div class="navbar-header">
		      <a href="/oakton" class="navbar-brand">Oakton</a>
		    </div>
		    <nav class="collapse navbar-collapse" role="navigation">
		      <ul class="nav navbar-nav pull-right">
		        <li>
		          <a href="/oakton/documentation/getting_started">Getting Started</a>
		        </li>
		        <li>
		          <a href="/oakton/documentation">Documentation</a>
		        </li>
		        <li>
		        <li>
<a href="https://gitter.im/jasperfx/oakton?utm_source=badge&amp;utm_medium=badge&amp;utm_campaign=pr-badge&amp;utm_content=badge"><img src="https://camo.githubusercontent.com/da2edb525cde1455a622c58c0effc3a90b9a181c/68747470733a2f2f6261646765732e6769747465722e696d2f4a6f696e253230436861742e737667" alt="Join the chat at https://gitter.im/jasperfx/oakton" data-canonical-src="https://badges.gitter.im/Join%20Chat.svg" style="max-width:100%;"></a>
		        </li>
		      	<li><a href="/oakton/documentation/aspnetcore/run" title="Run">Previous</a></li>
		      	<li><a href="/oakton/documentation/aspnetcore/extensions" title="Writing Extension Commands">Next</a></li>
		      </ul>
		      <div class="navbar-form navbar-left" role="search">
		        <div class="form-group">
		          <input id="search" type="search" class="form-control" placeholder="Search">
		        </div>
		      </div>

		    </nav>

		  </div>
		</nav>

		  <div class="container">
		  	<nav class="navbar-inverse">
		  		<ol class="breadcrumb"><li><a href="/oakton/">Oakton</a></li><li><a href="/oakton/documentation">Documentation</a></li><li><a href="/oakton/documentation/aspnetcore">Extended ASP.Net Core Command Line Options</a></li><li class="active">Environment Checks</li></ol>
		  	</nav>
		  </div>

		<!--main-->
		<div class="container">
			<div class="row">
		      <!--left-->

		      <div class="col-md-3" id="leftCol">
		      	<h3>Oakton 2.1.0</h3>
		      	<br />

				<ul class="nav nav-stacked affix" id="sidebar">

		        </ul>

		        	<h3 class="no-margin">Next</h3><p><a href="/oakton/documentation/aspnetcore/extensions">Writing Extension Commands</a></p>
		        	<h3 class="no-margin">Previous</h3><a href="/oakton/documentation/aspnetcore/run">Run</a></p>

		        </ul>
		      </div><!--/left-->

		      <!--right-->
		      <div class="col-md-9">
			      	<h1>Environment Checks<a href="https://github.com/jasperfx/oakton/blob/master/documentation/documentation/aspnetcore/environment.md"  class="text-muted small pull-right" style="margin-top: 10px"><i class="fa fa-github"></i> Edit on GitHub</a></h1>

			      	<hr />

			      	<div id="main-pane">
			      		<!--title:Environment Checks-->
<p>The big out of the box feature with Oakton.AspNetCore is the ability to expose environment checks or environment tests directly
in your application. Most applications don't live in isolation. Your code probably has to interact with databases, the file system, configuration mechanisms, and other services. And since it's an imperfect world, it's quite possible that you've made a deployment in your career and later found out that configuration items were wrong, your dependencies were down, the database credentials you were using were wrong, or all kinds of sundry run of the mill problems.</p>
<p>Years ago I worked on a system that had worlds of environmental issues during deployments, and after learning about the technique of &quot;environment tests&quot; where you build in automatic checks in your deployment to exercise your system's integrations, we adapted the approach described here: <a href="http://codebetter.com/jeremymiller/2006/04/06/environment-tests-and-self-diagnosing-configuration-with-structuremap/">Environment Tests and Self-Diagnosing Configuration</a>.</p>
<p>Flash forward to 2019 (at the time of this release), and Oakton.AspNetCore allows you to build environment checks right into your ASP.Net Core application such that you can verify successful deployments to verify the system configuration quickly rather than waiting for user error reports or testers being blocked because the system is down (which happened to me today as a matter of fact).</p>
<p>Here's a quick start. Let's say that your ASP.Net Core application talks to a single Sql Server application database, and that you expect
there to be a connection string in your <em>appsettings.json</em> like so:</p>
<pre><code>{
    &quot;connectionString&quot;: &quot;some connection string using integrated security&quot;
}
</code></pre>
<p>In a perfect world that just works and every thing is hunky dory. In the real world maybe the configuration is missing, the appsettings.json file didn't get copied over somehow, the service account your application is running under doesn't have access to the configured Sql Server database (this wasn't a random example), or the database just flat out doesn't exist (also not a random example).</p>
<p>To build in an environment check for database connectivity in this situation with <em>Oakton.AspNetCore</em>, get into your normal ASP.Net Core <code>Startup</code> class, and add an environment check in the <code>Startup.ConfigureServices()</code> method like this:</p>
<pre><code class="language-csharp">&#xA;// This method gets called by the runtime. Use this method to add services to the container.&#xA;public void ConfigureServices(IServiceCollection services)&#xA;{&#xA;    // Other registrations we don&#x27;t care about...&#xA;    &#xA;    // This extension method is in Oakton.AspNetCore&#xA;    services.CheckEnvironment&lt;IConfiguration&gt;(&quot;Can connect to the application database&quot;, config =&gt;&#xA;    {&#xA;        var connectionString = config[&quot;connectionString&quot;];&#xA;        using (var conn = new SqlConnection(connectionString))&#xA;        {&#xA;            // Just attempt to open the connection. If there&#x27;s anything&#xA;            // wrong here, it&#x27;s going to throw an exception&#xA;            conn.Open();&#xA;        }&#xA;    });&#xA;    &#xA;    // Ignore this please;)&#xA;    services.AddSingleton&lt;IDescribedSystemPart, Describer1&gt;();&#xA;    services.AddSingleton&lt;IDescribedSystemPart, Describer2&gt;();&#xA;    services.AddSingleton&lt;IDescribedSystemPart, Describer3&gt;();&#xA;}&#xA;</code></pre>
<p>Now, during deployments or even just pulling down the code to run locally, we can run the environment checks on our application like so:</p>
<pre><code>dotnet run -- check-env
</code></pre>
<p>Which in the case of our application above, blows up with output like this because I didn't add configuration for the database in the first place:</p>
<pre><code>Running Environment Checks
   1.) Failed: Can connect to the application database
System.InvalidOperationException: The ConnectionString property has not been initialized.
   at System.Data.SqlClient.SqlConnection.PermissionDemand()
   at System.Data.SqlClient.SqlConnectionFactory.Permissi
onDemand(DbConnection outerConnection)
   at System.Data.ProviderBase.DbConnectionInternal.TryOpenConnectionInternal(DbConnection outerConnection, DbConnectionFactory connectionFactory, TaskCompletionSource`1
 retry, DbConnectionOptions userOptions)
   at System.Data.ProviderBase.DbConnectionClosed.TryOpenConnection(DbConnection outerConnection, DbConnectionFactory connectionFactory, TaskCompletionSource`1 retry, 
DbConnectionOptions userOptions)
   at System.Data.SqlClient.SqlConnection.TryOpen(TaskCompletionSource`1 retry)
   at System.Data.SqlClient.SqlConnection.Open()
   at MvcApp.Startup.&lt;&gt;c.&lt;ConfigureServices&gt;b_
_4_0(IConfiguration config) in /Users/jeremydmiller/code/oakton/src/MvcApp/Startup.cs:line 41
   at Oakton.AspNetCore.Environment.EnvironmentCheckExtensions.&lt;&gt;c__DisplayClass2_0`1.&lt;CheckEnvironment&gt;b__0(IServ
iceProvider s, CancellationToken c) in /Users/jeremydmiller/code/oakton/src/Oakton.AspNetCore/Environment/EnvironmentCheckExtensions.cs:line 53
   at Oakton.AspNetCore.Environment.LambdaCheck.Assert(IServiceP
rovider services, CancellationToken cancellation) in /Users/jeremydmiller/code/oakton/src/Oakton.AspNetCore/Environment/LambdaCheck.cs:line 19
   at Oakton.AspNetCore.Environment.EnvironmentChecker.ExecuteAll
EnvironmentChecks(IServiceProvider services, CancellationToken token) in /Users/jeremydmiller/code/oakton/src/Oakton.AspNetCore/Environment/EnvironmentChecker.cs:line 31
</code></pre>
<p>If you ran this command during continuous deployment scripts, the command should cause your build to fail when it detects environment problems.</p>
<h2 id="how-it-works">How it works</h2>
<p>There's not much to it. <em>Oakton.AspNetCore</em> includes this interface:</p>
<pre><code class="language-csharp">&#xA;public interface IEnvironmentCheck&#xA;{&#xA;    string Description { get; }&#xA;&#xA;    Task Assert(IServiceProvider services, CancellationToken cancellation);&#xA;}&#xA;</code></pre>
<p><em>Oakton.AspNetCore</em> is looking for service registrations of this interface in your application's IoC container. The <code>CheckEnvironment()</code> extension method above just adds a service registration for the <code>IEnvironmentCheck</code> interface that runs the supplied lambda. When executing the environment checks, <em>Oakton.AspNetCore</em> runs each check
one within <code>try/catch</code> blocks. If the execution throws an exception, it's considered to be a failure. Otherwise, it's a passing check and comes out in the output color coded as green. <em>Oakton.AspNetCore</em> assumes that you take care of any necessary resource cleanup yourself.</p>
<p>If you ever want to run the environment checks outside of the command line, you can use the <code>EnvironmentChecker.ExecuteAllEnvironmentChecks(IServiceProvider)</code> method.</p>
<h2 id="running-environment-checks">Running Environment Checks</h2>
<p>To run the environment checks from the command line from your application, use this command:</p>
<pre><code>dotnet run -- check-env
</code></pre>
<p>Just like the <em>run</em> command, you can also override the hosting environment or configuration items like so:</p>
<pre><code>dotnet run -- check-env --environment UAT --config:filepath &quot;some file path&quot;
</code></pre>
<p>In addition, you can run the environment checks as part of the <em>run</em> command before starting Kestrel. If the environment checks
fail, the application doesn't start and the <code>Program.Main()</code> method will throw an exception to <a href="https://en.wikipedia.org/wiki/Fail-fast">fail fast</a>.</p>
<p>In the case of successful environment checks (what you hope happens everytime), you'll see output like this listing off the successful checks. <em>All environment checks are good!</em>
will be highlighted in green.</p>
<pre><code>Running Environment Checks
   1.) Success: good
   2.) Success: also good
All environment checks are good!
</code></pre>
<p>Just to reiterate that all the normal ASP.Net Core options are available, check out the command line help for the <em>check-env</em> command like so:</p>
<pre><code>dotnet run -- ? check-env
</code></pre>
<p>Which gives the following output:</p>
<pre><code> Usages for 'check-env' (Execute all environment checks against the application)
  check-env [-f, --file &lt;file&gt;] [-e, --environment &lt;environment&gt;] [-v, --verbose] [-l, --log-level &lt;logleve&gt;] [----config:&lt;prop&gt; &lt;value&gt;]

  ------------------------------------------------------------------------------------------------------------------
    Flags
  ------------------------------------------------------------------------------------------------------------------
                  [-f, --file &lt;file&gt;] -&gt; Use to optionally write the results of the environment checks to a file
    [-e, --environment &lt;environment&gt;] -&gt; Use to override the ASP.Net Environment name
                      [-v, --verbose] -&gt; Write out much more information at startup and enables console logging
          [-l, --log-level &lt;logleve&gt;] -&gt; Override the log level
          [----config:&lt;prop&gt; &lt;value&gt;] -&gt; Overwrite individual configuration items
  ------------------------------------------------------------------------------------------------------------------
</code></pre>
<h2 id="adding-environment-checks">Adding Environment Checks</h2>
<p>The easiest thing to do is to use the extension methods on <code>IServiceCollection</code> shown below:</p>
<pre><code class="language-csharp">&#xA;// This method gets called by the runtime. Use this method to add services to the container.&#xA;public void ConfigureServices(IServiceCollection services)&#xA;{&#xA;    // Other registrations we don&#x27;t care about...&#xA;    &#xA;    // This extension method is in Oakton.AspNetCore&#xA;    services.CheckEnvironment&lt;IConfiguration&gt;(&quot;Can connect to the application database&quot;, config =&gt;&#xA;    {&#xA;        var connectionString = config[&quot;connectionString&quot;];&#xA;        using (var conn = new SqlConnection(connectionString))&#xA;        {&#xA;            // Just attempt to open the connection. If there&#x27;s anything&#xA;            // wrong here, it&#x27;s going to throw an exception&#xA;            conn.Open();&#xA;        }&#xA;    });&#xA;    &#xA;    // Ignore this please;)&#xA;    services.AddSingleton&lt;IDescribedSystemPart, Describer1&gt;();&#xA;    services.AddSingleton&lt;IDescribedSystemPart, Describer2&gt;();&#xA;    services.AddSingleton&lt;IDescribedSystemPart, Describer3&gt;();&#xA;}&#xA;</code></pre>
<p>There are various overloads of <code>CheckEnvironment()</code> for both synchronous and asynchronous checks, and specialized
shortcuts as shown above that let you specify a specific service registered in your IoC container for the check. Otherwise, the overloads take in either
<code>Func&lt;IServiceProvider, CancellationToken, Task&gt;</code> for asynchronous checks or <code>Action&lt;IServiceProvider&gt;</code> for synchronous code checks.</p>
<h2 id="custom-environment-checks">Custom Environment Checks</h2>
<p>You can create custom, reusable environment checks by implementing the interface below:</p>
<pre><code class="language-csharp">&#xA;public interface IEnvironmentCheck&#xA;{&#xA;    string Description { get; }&#xA;&#xA;    Task Assert(IServiceProvider services, CancellationToken cancellation);&#xA;}&#xA;</code></pre>
<p>And adding your custom type to your service registrations when you configure your IoC container (<code>Startup.ConfigureServices()</code>).</p>
<h2 id="required-files">Required Files</h2>
<p>There's a specialized, built in check for required files like so:</p>
<pre><code class="language-csharp">&#xA;public static void CheckThatFileExists(this IServiceCollection services, string path)&#xA;{&#xA;    var check = new FileExistsCheck(path);&#xA;    services.AddSingleton&lt;IEnvironmentCheck&gt;(check);&#xA;}&#xA;</code></pre>
<h2 id="required-service-registration">Required Service Registration</h2>
<p>There's also a specialized check to ascertain that a required IoC service registration exists:</p>
<pre><code class="language-csharp">&#xA;public static void CheckServiceIsRegistered&lt;T&gt;(this IServiceCollection services)&#xA;{&#xA;    services.CheckEnvironment($&quot;Service {typeof(T).FullName} should be registered&quot;, s =&gt; s.GetRequiredService&lt;T&gt;());&#xA;}&#xA;&#xA;public static void CheckServiceIsRegistered(this IServiceCollection services, Type serviceType)&#xA;{&#xA;    services.CheckEnvironment($&quot;Service {serviceType.FullName} should be registered&quot;, s =&gt; s.GetRequiredService(serviceType));&#xA;}&#xA;</code></pre>

			      	</div>

			      	<hr />

			      	<nav>
				        <span>
				        	<strong>Previous: </strong><a href="/oakton/documentation/aspnetcore/run">Run</a>

				        </span>
				        <span class="pull-right">

				        	<strong>Next: </strong><a href="/oakton/documentation/aspnetcore/extensions">Writing Extension Commands</a>

				        </span>
			      	</nav>

		      </div><!--/right-->
		  	</div><!--/row-->
		</div><!--/container-->

<script type='text/javascript' src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>
$('#search').keyup(function(e){
  if(e.keyCode == 13) {
    var search = $('#search').val();

    var url = 'https://www.google.com/#q=site:http://jasperfx.github.io/oakton ' + search;
    url = encodeURI(url);

    //alert(url);

    window.location.href = url;

    e.stopPropagation();
    if (e.cancelBubble!=null) e.cancelBubble = true;
    return false;
  }



});

</script>
    </body>


    <foot>
        <script type='text/javascript' src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
        <script type='text/javascript' src="https://netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>

        <script type="text/javascript" src="/oakton/content/embed.js"></script>
        <script type="text/javascript" src="/oakton/content/prism.js"></script>
        <script type="text/javascript" src="/oakton/content/sidebar.js"></script>
        <script type="text/javascript" src="/oakton/content/affix.js"></script>
    </foot>
</html>
